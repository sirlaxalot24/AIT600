(function(jobsearch,$,undefined){var places_autocomplete=null;jobsearch.form_defaults={};jobsearch.form_defaults.debug=true;jobsearch.form_defaults.radius_initialize_location=true;jobsearch.form_defaults.radius_initialize_distance=true;jobsearch.form_defaults.radius_distance_default=20;jobsearch.form_defaults.radius_distance=20;jobsearch.form_defaults.radius_distance_alt=null;jobsearch.form_defaults.radius_distance_in_miles=false;jobsearch.form_defaults.radius_select_first_item_on_enter_blur=true;jobsearch.form_defaults.radius_administrative_area_is_city_names=["Tokyo","Jakarta"];jobsearch.form_defaults.input_selectors={location:"input[type=hidden][name=location]",location_state:"input[type=hidden][name=location_state]",location_country:"input[type=hidden][name=location_country]",radius:"input[type=hidden][name=radius]",ns_location:"input[type=text][name=ns_location]",ns_dist_radio:"input[type=radio][name=ns_dist]",ns_dist_text:"input[type=text][name=ns_dist]",ns_dist_select:"select[name=ns_dist]",ns_dist_alt_text:"input[type=text][name=ns_dist_alt]"}
jobsearch.form=function(form_id,options){options=options||{};this.debug=(typeof options.debug!=='undefined')?options.debug:jobsearch.form_defaults.debug;this.radius_initialize_location=(typeof options.radius_initialize_location!=='undefined')?options.radius_initialize_location:jobsearch.form_defaults.radius_initialize_location;this.radius_initialize_distance=(typeof options.radius_initialize_distance!=='undefined')?options.radius_initialize_distance:jobsearch.form_defaults.radius_initialize_distance;this.radius_select_first_item_on_enter_blur=(typeof options.radius_select_first_item_on_enter_blur!=='undefined')?options.radius_select_first_item_on_enter_blur:jobsearch.form_defaults.radius_select_first_item_on_enter_blur;this.radius_distance_default=(typeof options.radius_distance_default!=='undefined')?options.radius_distance_default:jobsearch.form_defaults.radius_distance_default;this.radius_distance=(typeof options.radius_distance!=='undefined')?options.radius_distance:jobsearch.form_defaults.radius_distance;this.radius_distance_alt=(typeof options.radius_distance_alt!=='undefined')?options.radius_distance_alt:jobsearch.form_defaults.radius_distance_alt;this.radius_distance_in_miles=(typeof options.radius_distance_in_miles!=='undefined')?options.radius_distance_in_miles:jobsearch.form_defaults.radius_distance_in_miles;this.radius_administrative_area_is_city_names=(typeof options.radius_administrative_area_is_city_names!=='undefined')?options.radius_administrative_area_is_city_names:jobsearch.form_defaults.radius_administrative_area_is_city_names;this.input_selectors=(typeof options.input_selectors!=='undefined')?options.input_selectors:jobsearch.form_defaults.input_selectors;this.onAfterRadiusInit=(typeof options.onAfterRadiusInit=='function')?options.onAfterRadiusInit:null;this.onSubmit=(typeof options.onSubmit=='function')?options.onSubmit:null;this.onBeforePlaceLoad=(typeof options.onBeforePlaceLoad=='function')?options.onBeforePlaceLoad:null;this.placeTypes=(typeof options.placeTypes!=='undefined')?options.placeTypes:['geocode'];this.placeComponentRestrictions=(typeof options.placeComponentRestrictions!=='undefined')?options.placeComponentRestrictions:{};this.jform=$("form#"+form_id);this.jinputs={};if(this._is_a_valid_job_search_form()){var _this=this;this.jform.submit(function(e){if(_this._pre_form_submit(e)==false){e.preventDefault();return false;}if(typeof _this.onSubmit=='function'){if(_this.onSubmit(e)==false){e.preventDefault();return false;}}});if(this.radius_initialize_location){this.radius_init_location(function(){if(typeof this.onAfterRadiusInit=='function'){this.onAfterRadiusInit()}});}if(this.radius_initialize_distance){this.radius_init_distance();}}else{if(this.debug){console.log("not a valid form requires an action: /jobs/search and method: get")}}}
jobsearch.form.prototype._is_a_valid_job_search_form=function(){return(this.jform.length>0&&this.jform.attr("action").indexOf("/search")>-1)}
jobsearch.form.prototype._has_a_location_input=function(){return(this.jform.length>0)}
jobsearch.form.prototype._set_and_check_input=function(name,selector,skiperr){if(selector!=null&&selector.length>1){var jinput=this.jform.find(selector);var check=(jinput.length>0);if(check){this.jinputs[name]=jinput;}else{if(skiperr!=true){if(this.debug){console.log("ERROR: form input "+name+" required: "+selector+" with value=\"\{\{ params['{name}'] | escape_html \}\}\"")}}}}else{if(this.debug){console.log("ERROR: form input "+name+" invalid selector:")}}return check;}
jobsearch.form.prototype._pre_form_submit=function(e){try{this.on_location_change();return true;}catch(e){return false;}}
jobsearch.form.prototype.on_location_change=function(e){if(!this.radius_lcache_is_current_location()){this.radius_reset_location_all();var input_location=this.jinputs["ns_location"];if(input_location.val().length>1){this.jinputs["location"].val(input_location.val());}}else{this.radius_update_form_distance()}}
jobsearch.form.prototype.radius_lcache_is_current_location=function(){var input_location=this.jinputs["ns_location"];var input_lcache=getCookie("ns_lcache");var locationstring=input_location.val();var lcache=input_lcache;if(locationstring==null||locationstring==""){return false;}if(lcache==null||lcache==""){return false;}if(lcache.indexOf(this.radius_string_checksum(locationstring))>-1){return true;}return false}
jobsearch.form.prototype.radius_update_form_distance=function(){var input_lcache=getCookie("ns_lcache");if(input_lcache.indexOf("RADIUS")>-1){var radius=this.jinputs["radius"].val();var rx=radius.split(",");if(rx.length>=3){rx[2]=this.radius_calculate_disance();this.jinputs["radius"].val(rx.join(","));}}}
jobsearch.form.prototype.radius_init_location=function(callback){if(this._set_and_check_input("location",this.input_selectors.location)&&this._set_and_check_input("location_state",this.input_selectors.location_state)&&this._set_and_check_input("location_country",this.input_selectors.location_country)&&this._set_and_check_input("radius",this.input_selectors.radius)&&this._set_and_check_input("ns_location",this.input_selectors.ns_location)){var _this=this
csns.maps.script.load(function(){_this.radius_setup_autocomplete();if(typeof callback=='function'){callback();}});var input_location=this.jinputs["ns_location"];input_location.change(function(e){_this.on_location_change();});this.on_location_change();}}
jobsearch.form.prototype.radius_init_distance=function(){this._set_and_check_input("ns_dist_alt",this.input_selectors.ns_dist_alt_text,true);if(this._set_and_check_input("ns_dist",this.input_selectors.ns_dist_radio,true)){this.radius_distance_set_radio();}else if(this._set_and_check_input("ns_dist",this.input_selectors.ns_dist_text,true)){this.radius_distance_set_text();}else if(this._set_and_check_input("ns_dist",this.input_selectors.ns_dist_select,true)){this.radius_distance_set_select();}else{if(this.debug){console.log("ERROR: form input "+name+" no match to radio list or select dropdown")}return false;}var _this=this;var input_dist=this.jinputs["ns_dist"];input_dist.change(function(e){var jinput=$(e.currentTarget);if(jinput.val()=="other"){_this.radius_distance=parseInt(input_dist_alt.val());}else{_this.radius_distance=parseInt(jinput.val());}});var input_dist_alt=this.jinputs["ns_dist_alt"];if(input_dist_alt){if(this.radius_distance_alt){input_dist_alt.val(this.radius_distance_alt)}input_dist_alt.change(function(e){if(input_dist.val()=="other"){var jinput=$(e.currentTarget);_this.radius_distance=parseInt(jinput.val());}});}}
jobsearch.form.prototype.radius_distance_set_radio=function(){var _this=this;var isoptionchecked=false;this.jinputs["ns_dist"].each(function(i,obj){var val=$(obj).val();var rd=_this.radius_distance;if(""+val==""+rd){$(obj).prop("checked",true);isoptionchecked=true;}});if(!isoptionchecked){this.jinputs["ns_dist"].each(function(i,obj){var val=$(obj).val();var rdef=_this.radius_distance_default;if(""+val==""+rdef){$(obj).prop("checked",true);isoptionchecked=true;}});if(!isoptionchecked){this.jinputs["ns_dist"].first().prop("checked",true);}}}
jobsearch.form.prototype.radius_distance_set_text=function(){var rd=this.radius_get_disance();this.jinputs["ns_dist"].val(rd);}
jobsearch.form.prototype.radius_distance_set_select=function(){var hasval=false;var has_other=false;var _this=this;this.jinputs["ns_dist"].find("option").each(function(i,option){if($(option).val()==_this.radius_distance){hasval=true}if($(option).val()=="other"){has_other=true}});if(hasval){this.jinputs["ns_dist"].val(this.radius_distance);}else{this.jinputs["ns_dist"].find("option").each(function(i,option){if($(option).val()==_this.radius_distance_default){_this.jinputs["ns_dist"].val(_this.radius_distance_default);hasval=true;}});if(!hasval&&has_other){this.jinputs["ns_dist"].val("other");if(this.jinputs["ns_dist_alt"]){this.jinputs["ns_dist_alt"].val(this.radius_distance_alt);}}}}
jobsearch.form.prototype.radius_setup_autocomplete=function(){var input_location=this.jinputs["ns_location"];var _this=this;this.places_autocomplete=new google.maps.places.Autocomplete(input_location.get(0));this.places_autocomplete.setTypes(this.placeTypes);this.places_autocomplete.setComponentRestrictions(this.placeComponentRestrictions);google.maps.event.addListener(_this.places_autocomplete,'place_changed',function(){var place=_this.places_autocomplete.getPlace();if(!place.geometry){return;}else{var location_string=input_location.val();var result=_this.radius_geo_results_parse(place);_this.radius_set_form_location_params(place,result,location_string);}});input_location.on("keypress",function(e){if(e.which==13){e.preventDefault();var __this=_this;console.log("a")
window.setTimeout(function(){console.log("b");__this.jform.submit();},1000);}});if(this.radius_select_first_item_on_enter_blur){this._kdeventlistner=null;var input=input_location[0];var _addEventListener=(input.addEventListener)?input.addEventListener:input.attachEvent;var _this=this
function event_wrapper(type,listener){if(type=="keydown"){_this._kdeventlistner=listener;}if(type=="keydown"||type=="blur"){var bak_listener=listener;var __this=_this;listener=function(event){var item_selected=$(".pac-item-selected").length>0;if(((type=="keydown"&&event.which==13)||type=="blur")&&!item_selected){var event_down=$.Event("keydown",{keyCode:40,which:40});__this._kdeventlistner.apply(input,[event_down]);}bak_listener.apply(input,[event]);};}_addEventListener.apply(input,[type,listener]);}input.addEventListener=event_wrapper;input.attachEvent=event_wrapper;}}
jobsearch.form.prototype.radius_geo_results_parse=function(place){var returnval="";if(this.radius_address_contains_city_level(place.address_components)===true){var latitude=place.geometry.location.lat();var longitude=place.geometry.location.lng();returnval=latitude+","+longitude;}else{var country="";var state="";$.each(place.address_components,function(i,component){if($.inArray("administrative_area_level_1",component.types)>-1){state=component.short_name;}if($.inArray("country",component.types)>-1){country=component.long_name;}});returnval=country+";"+state;}return returnval;}
jobsearch.form.prototype.radius_address_contains_city_level=function(address_components){var returnVal=false;$.each(address_components,function(i,component){if($.inArray("locality",component.types)>-1){returnVal=true;return;}if($.inArray("administrative_area_level_1",component.types)>-1&&$.inArray(component.short_name,this.radius_administrative_area_is_city_names)>-1){returnVal=true;return;}});return returnVal;}
jobsearch.form.prototype.radius_get_disance=function(){var rd=this.radius_distance_default||20;if(this.radius_distance!=null){if(!isNaN(parseInt(this.radius_distance))){rd=parseInt(this.radius_distance);}else if(this.radius_distance=="other"&&!isNaN(parseInt(this.radius_distance_alt))){rd=parseInt(this.radius_distance_alt);}}return rd;}
jobsearch.form.prototype.radius_calculate_disance=function(){var rd=this.radius_get_disance();if(this.radius_distance_in_miles==true){rd=rd*1.6;}return rd;}
jobsearch.form.prototype.radius_set_form_location_params=function(place,result,location_string){if(typeof(this.onBeforePlaceLoad)=="function"){var beforeresult=this.onBeforePlaceLoad(place,result,location_string);place=beforeresult[0];result=beforeresult[1];location_string=beforeresult[2];}if(result!=null&&result!=""){this.radius_reset_location();var resulttype=result.indexOf(";")>-1?"LOCATION":"RADIUS";setCookie("ns_lcache",this.radius_string_checksum(location_string)+"-"+resulttype,0);this.radius_reset_location();if(result!=""){if(resulttype=="LOCATION"){var country=result.split(";")[0];var state=result.split(";")[1];this.jinputs["location_country"].val(country);this.jinputs["location_state"].val(state);}else{var distance=this.radius_calculate_disance();this.jinputs["radius"].val(result+","+distance);}}}else{this.radius_reset_location_all();}}
jobsearch.form.prototype.radius_reset_location_all=function(){setCookie("ns_lcache","",0);this.radius_reset_location();}
jobsearch.form.prototype.radius_reset_location=function(){this.jinputs["radius"].val("");this.jinputs["location"].val("");this.jinputs["location_state"].val("");this.jinputs["location_country"].val("");}
jobsearch.form.prototype.radius_string_checksum=function(str){var hash=0,i,chr,len;if(str.length==0)return hash;for(i=0,len=str.length;i<len;i++){chr=str.charCodeAt(i);hash=((hash<<5)-hash)+chr;hash|=0;}return hash;}}(window.tmjobsearch=window.tmjobsearch||{},$cs||jQuery));